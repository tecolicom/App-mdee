#!/usr/bin/env bash
# vim: filetype=bash :  -*- mode: sh; sh-shell: bash; -*-

set -euo pipefail

define() { IFS='\n' read -r -d '' ${1} || true ; }

myname="${0##*/}"

define pod <<"=cut"

=encoding utf-8

=head1 NAME

mdv - Markdown viewer using greple and nup

=head1 SYNOPSIS

    mdv [ options ] file ...

     -h  --help             show help
         --version          show version
     -d  --debug            debug mode
     -n  --dryrun           dry-run mode
         --fold             enable line folding (default: on)
         --no-fold          disable line folding
         --table            enable table formatting (default: on)
         --no-table         disable table formatting
         --nup              use nup for paged output (default: on)
         --no-nup           disable nup, output to stdout
     -w  --width=#          fold width (default: 80)
     -C  --pane=#           number of columns
     -R  --row=#            number of rows
     -G  --grid=#           grid layout (e.g., 2x3)
     -P  --page=#           page height in lines
     -S  --pane-width=#     pane width (default: 85)
    --bs --border-style=#   border style
         --pager=#          pager command (empty to disable)
         --no-pager         disable pager

=head1 VERSION

Version 0.01

=cut

[[ $pod =~ Version\ +([0-9.]+) ]] && my_version=${BASH_REMATCH[1]}

##############################################################################
# Utility functions
##############################################################################

debug() {
    [[ ${debug:-} ]] && echo "debug: $*" >&2 || true
}

die() {
    echo "$myname: $*" >&2
    exit 1
}

# Check bash version (4.3+ required for getoptlong.sh)
if ((BASH_VERSINFO[0] < 4 || (BASH_VERSINFO[0] == 4 && BASH_VERSINFO[1] < 3))); then
    die "bash 4.3+ required (found $BASH_VERSION)"
fi

##############################################################################
# Option definitions
##############################################################################

define USAGE <<END
mdv - Markdown viewer using greple and nup

Usage: $myname [ options ] file ...
END

declare -a up_opts=(--document --no-filename)
declare width=80
declare fold=1
declare table=1
declare nup=1

declare -A OPTS=(
    [&REQUIRE]=0.7 [&USAGE]="$USAGE" [&PERMUTE]=
    [         help | h   !        # show help         ]=
    [      version |     !        # show version      ]=
    [        debug | d            # debug mode        ]=
    [       dryrun | n            # dry-run mode      ]=
    [         fold |              # line folding      ]=1
    [        table |              # table formatting  ]=1
    [          nup |              # use nup           ]=1
    [        width | w  :=i       # fold width        ]=80
    [        pager |    :!        # pager command     ]=
    [         grid | G  :>up_opts # grid layout       ]=
    [         pane | C  :>up_opts # number of columns ]=
    [          row | R  :>up_opts # number of rows    ]=
    [         page | P  :>up_opts # page height       ]=
    [   pane-width | S  :>up_opts # pane width        ]=
    [ border-style | bs :>up_opts # border style      ]=
)

##############################################################################
# Option callbacks
##############################################################################

help() {
    sed -E \
        -e '/^$/N' \
        -e 's/^(\n*)=head[0-9]* */\1/' \
        -e '/^\n*[#=]/d' \
        -e '/Version/q' \
        <<< "$pod"
    exit 0
}

version() {
    echo "$my_version"
    exit 0
}

pager() {
    if [[ -z $2 ]]; then
        up_opts+=("--no-pager")
    else
        up_opts+=("--pager=$2")
    fi
}

##############################################################################
# Parse options
##############################################################################

. getoptlong.sh OPTS "$@"

##############################################################################
# Main
##############################################################################

if (( $# == 0 )) && [[ -t 0 ]]; then
    help
fi

##############################################################################
# Markdown highlighting with greple
##############################################################################

ITEM_PREFIX='^\h*(?:[*-]|\d+\.)\h+'

declare -a greple_opts=(-G --ci=G --all --need=0)

# Base color for headers
BASE=NavyBlue

# HTML comments (dimmed)
greple_opts+=(--cm "<${BASE}>+r60" -E '<!--.*?-->')

# Bold text
greple_opts+=(--cm "<${BASE}>D" -E '\*\*.*?\*\*')

# Headers (h1-h5)
greple_opts+=(
    --cm "L25DE/<${BASE}>"     -E '^#\h+.*'
    --cm "L25DE/<${BASE}>+l10" -E '^##\h+.*'
    --cm "L00DN/<${BASE}>=l93" -E '^###\h+.*'
    --cm "<${BASE}>UD"         -E '^####\h+.*'
    --cm "<${BASE}>+l20;U"     -E '^#####+.*'
)

# Inline code (backticks)
greple_opts+=(--cm '/L23,/L23,/L23' -E '(?<bt>`++)((?:(?!\g{bt}).)++)(\g{bt})')

# Code blocks (fenced)
greple_opts+=(
    --cm "L20 , <${BASE}>=l85 , <${BASE}>/L23;E , L20" \
    -E '^\h*(?<bt>`{3,}+)(.*)\n((?s:.*?))^\h*(\g{bt})'
)

##############################################################################
# Build command pipeline
##############################################################################

# Fold filter: wrap long lines with ansifold
fold_filter() {
    if [[ $fold == 1 ]]; then
        greple \
            -Mtee \&ansifold --crmode --autoindent="${ITEM_PREFIX}" -sw${width} -- \
            -E "${ITEM_PREFIX}.*\n" --crmode --all --need=0 --no-color
    else
        cat
    fi
}

# Table filter: format markdown tables with ansicolumn
table_filter() {
    if [[ $table == 1 ]]; then
        greple \
            -Mtee::config=discrete \&ansicolumn -s '|' -o '|' -t --cu=1 -- \
            -E '^(\|.+\|\n){3,}' --all --need=0 --no-color \
        | perl -pE 's/ /-/g if /^ \| (\s* -+ \s* \|)+ $/x'
    else
        cat
    fi
}

md_filter() {
    greple "${greple_opts[@]}" "$1" \
    | fold_filter \
    | table_filter
}

# Build nup command
declare -a nup_cmd=(nup "${up_opts[@]}")

debug "fold: $fold, table: $table, nup: $nup"
debug "up_opts: ${up_opts[*]}"
debug "nup_cmd: ${nup_cmd[*]}"

# Process files
if (( $# == 0 )); then
    # stdin mode (not supported yet)
    die "stdin mode not supported, please specify file(s)"
fi

# Output filter: nup or cat
output_filter() {
    if [[ ${dryrun:-} ]]; then
        [[ $nup == 1 ]] && echo "${nup_cmd[*]}" || echo "cat"
        cat > /dev/null
    elif [[ $nup == 1 ]]; then
        "${nup_cmd[@]}"
    else
        cat
    fi
}

# Process each file through md_filter and output
{
    for file in "$@"; do
        [[ -f $file ]] || die "file not found: $file"
        md_filter "$file"
    done
} | output_filter

: <<'=cut'

=head1 DESCRIPTION

B<mdv> is a Markdown viewer command that combines L<greple(1)> for
syntax highlighting with L<nup(1)> for multi-column paged output.

It provides colorized display of Markdown files with support for:

=over 4

=item * Headers (h1-h5) with distinct styling

=item * Bold text

=item * Inline code (backticks)

=item * Code blocks (fenced with ```)

=item * HTML comments (dimmed)

=item * Tables (formatted with ansicolumn)

=item * List items with proper indentation

=back

=head1 OPTIONS

=head2 General Options

=over 4

=item B<-h>, B<--help>

Show help message.

=item B<--version>

Show version.

=item B<-d>, B<--debug>

Enable debug mode.

=item B<-n>, B<--dryrun>

Dry-run mode. Show the command without executing.

=back

=head2 Processing Options

=over 4

=item B<--fold>, B<--no-fold>

Enable or disable line folding for list items.  When enabled, long
lines in list items are wrapped with proper indentation using
L<ansifold(1)>.  Default is enabled.

=item B<--table>, B<--no-table>

Enable or disable table formatting.  When enabled, Markdown tables
are formatted using L<ansicolumn(1)> for aligned column display.
Default is enabled.

=item B<--nup>, B<--no-nup>

Enable or disable L<nup(1)> for multi-column paged output.  When
disabled, output goes directly to stdout without formatting.
Default is enabled.

=item B<-w> I<N>, B<--width>=I<N>

Set the fold width for text wrapping. Default is 80.
Only effective when C<--fold> is enabled.

=back

=head2 Layout Options (passed to nup)

=over 4

=item B<-C> I<N>, B<--pane>=I<N>

Set the number of columns (panes).

=item B<-R> I<N>, B<--row>=I<N>

Set the number of rows.

=item B<-G> I<CxR>, B<--grid>=I<CxR>

Set grid layout. For example, C<-G2x3> creates 2 columns and 3 rows.

=item B<-P> I<N>, B<--page>=I<N>

Set the page height in lines.

=item B<-S> I<N>, B<--pane-width>=I<N>

Set the pane width in characters. Default is 85.

=item B<--bs>=I<STYLE>, B<--border-style>=I<STYLE>

Set the border style.

=back

=head2 Pager Options

=over 4

=item B<--pager>=I<COMMAND>

Set the pager command.
Use C<--pager=> (empty) or C<--no-pager> to disable pager.

=item B<--no-pager>

Disable pager.

=back

=head1 EXAMPLES

    mdv README.md              # view markdown file
    mdv -C2 document.md        # 2-column view
    mdv -G2x2 manual.md        # 2x2 grid (4-up)
    mdv -w60 narrow.md         # narrower text width
    mdv --no-pager file.md     # without pager
    mdv --no-nup file.md       # output to stdout without nup
    mdv --no-fold file.md      # disable line folding
    mdv --no-table file.md     # disable table formatting

=head1 DEPENDENCIES

This command requires the following:

=over 4

=item * L<App::Greple> - pattern matching and highlighting

=item * L<App::Greple::tee> - filter integration

=item * L<App::ansifold> - ANSI-aware text folding

=item * L<App::ansicolumn> - ANSI-aware column formatting

=item * L<App::nup> - N-up multi-column paged output

=item * L<Getopt::Long::Bash> - bash option parsing

=back

=head1 SEE ALSO

L<nup(1)>, L<greple(1)>, L<ansifold(1)>, L<ansicolumn(1)>

=head1 AUTHOR

Kazumasa Utashiro

=head1 LICENSE

Copyright 2025 Kazumasa Utashiro.

This software is released under the MIT License.
L<https://opensource.org/licenses/MIT>

=cut
